<!DOCTYPE html>
<html>
<head>
    <title>HMM Tactical Tracker (VIX9D)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .data-box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .data-box h3 { margin-top: 0; }
        .panic-text { font-size: 2em; font-weight: bold; }
        .panic-high { color: #d9534f; } /* Red */
        .panic-low { color: #5cb85c; }  /* Green */
        .vix-text { font-size: 1.5em; color: #337ab7; }
        #chart-container { height: 450px; }
    </style>
</head>
<body>
    <h2>HMM Market Regime Tracker (Tactical VIX9D Spread)</h2>
    <p>Focusing on the 9-Day vs 30-Day Volatility spread for weekly options safety.</p>

    <div id="loading" style="text-align: center; font-style: italic;">Loading tactical data...</div>
    
    <div id="data-display" style="display: none;">
        <div class="data-box">
            <h3>Current Market Psychology (Latest Close)</h3>
            <div id="summary">
                <p><strong>Date:</strong> <span id="market-date">--</span></p>
                <p><strong>VIX Close (30-day):</strong> <span id="vix-close" class="vix-text">--</span></p>
                <p><strong>VIX Term Structure (9D-30D):</strong> <span id="vix-term-structure">--</span></p>
                <p><strong>HMM Panic Probability:</strong> 
                    <span id="hmm-panic-probability" class="panic-text">--</span>
                </p>
                <p><strong>HMM CHECK:</strong> <span id="hmm-check-regime">--</span></p>
            </div>
        </div>
        
        <div id="chart-container">
            <canvas id="hmmChart"></canvas>
        </div>
    </div>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const HMM_URL = 'chart_data.json'; 

        fetch(HMM_URL)
            .then(response => {
                if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
                return response.json();
            })
            .then(data => {
                // Ensure the flat structure exists
                if (!data || !data.dates) {
                    console.error("Data structure mismatch. Found keys:", Object.keys(data));
                    return;
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-display').style.display = 'block';

                // --- Update Summary Box ---
                const isBackwardation = data.vix_spread > 0;
                const statusText = isBackwardation ? "Backwardation (Panic)" : "Contango (Healthy)";
                const statusClass = isBackwardation ? "panic-high" : "panic-low";

                document.getElementById('market-date').textContent = data.date;
                document.getElementById('vix-close').textContent = Number(data.vix_close).toFixed(2);
                
                const termElement = document.getElementById('vix-term-structure');
                termElement.textContent = `${statusText} (${data.vix_spread.toFixed(2)})`;
                termElement.className = statusClass;

                const panicProb = data.panic_probability;
                const panicProbElement = document.getElementById('hmm-panic-probability');
                panicProbElement.textContent = `${panicProb.toFixed(1)}%`;
                panicProbElement.className = panicProb > 70 ? 'panic-text panic-high' : 'panic-text panic-low';

                document.getElementById('hmm-check-regime').innerHTML = 
                    `The market is statistically in a **${panicProb > 70 ? "HIGH-VOLATILITY" : "CALM"}** regime.`;

                // --- Chart Configuration ---
                const ctx = document.getElementById('hmmChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [
                            {
                                label: 'HMM Panic Probability (%)',
                                data: data.prob_values,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                yAxisID: 'y_prob',
                                fill: true,
                                tension: 0.2
                            },
                            {
                                label: 'VIX Close',
                                data: data.vix_values,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                yAxisID: 'y_vix',
                                pointRadius: 0,
                                borderWidth: 1.5,
                                tension: 0.2
                            },
                            {
                                label: '9D-30D Spread',
                                data: data.spread_values,
                                borderColor: 'rgba(255, 159, 64, 1)',
                                yAxisID: 'y_spread',
                                pointRadius: 0,
                                borderWidth: 2,
                                tension: 0.2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { type: 'time', time: { unit: 'month' } },
                            y_prob: {
                                type: 'linear',
                                position: 'left',
                                min: 0, max: 100,
                                title: { display: true, text: 'Panic Probability (%)' }
                            },
                            y_vix: {
                                type: 'linear',
                                position: 'right',
                                min: 10, max: 50,
                                stack: 'right-stack',
                                stackWeight: 1,
                                title: { display: true, text: 'VIX Close' }
                            },
                            y_spread: {
                                type: 'linear',
                                position: 'right',
                                min: -6, max: 6,
                                stack: 'right-stack',
                                stackWeight: 0.5,
                                title: { display: true, text: 'VIX9D-VIX Spread' }
                            }
                        },
                        plugins: {
                            annotation: {
                                annotations: {
                                    zeroLine: {
                                        type: 'line',
                                        yScaleID: 'y_spread',
                                        yMin: 0, yMax: 0,
                                        borderColor: 'rgba(255, 159, 64, 0.7)',
                                        borderWidth: 2,
                                        borderDash: [6, 4],
                                        label: {
                                            display: true,
                                            content: 'FLIP POINT (0)',
                                            position: 'start'
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading').textContent = "Error loading data. Ensure GitHub Action has finished.";
            });
      });
    </script>
</body>
</html>
