<!DOCTYPE html>
<html>
<head>
    <title>HMM Market Regime Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .data-box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .data-box h3 { margin-top: 0; }
        .panic-text { font-size: 2em; font-weight: bold; }
        .panic-high { color: #d9534f; } /* Red for Panic > 50% */
        .panic-low { color: #5cb85c; } /* Green for Panic < 50% */
        .vix-text { font-size: 1.5em; color: #337ab7; }
        #chart-container { height: 450px; }
    </style>
</head>
<body>

    <h2>HMM Market Regime Tracker (Last 1 Year)</h2>
    <p>Displays the daily calculated probability of the S&P 500 being in the High-Volatility ('Panic') regime.</p>

    <div id="loading" style="text-align: center; font-style: italic;">Loading data...</div>
    
    <div id="data-display" style="display: none;">
        <div class="data-box">
            <h3>Current Market Psychology (Latest Close)</h3>
            <p>Date: <span id="latest-date"></span></p>
            <p>VIX Close: <span id="latest-vix" class="vix-text"></span></p>
            <p>HMM Panic Probability: 
                <span id="latest-panic-prob" class="panic-text"></span>
            </p>
            <p id="alert-message"></p>
        </div>
        
        <div id="chart-container">
            <canvas id="hmmChart"></canvas>
        </div>
    </div>

    <script>
        const DATA_URL = 'chart_data.json';
        
        async function loadChartData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-display').style.display = 'block';

                const ctx = document.getElementById('hmmChart').getContext('2d');
                
                // --- Update Latest Readings ---
                const lastReading = data.last_reading;
                const panicProb = (lastReading.P_Panic * 100).toFixed(1) + '%';
                
                document.getElementById('latest-date').textContent = lastReading.Date;
                document.getElementById('latest-vix').textContent = lastReading.VIX_Close;
                document.getElementById('latest-panic-prob').textContent = panicProb;

                const panicElement = document.getElementById('latest-panic-prob');
                const alertMessage = document.getElementById('alert-message');
                const isPanic = lastReading.P_Panic > 0.5;
                
                panicElement.classList.remove(isPanic ? 'panic-low' : 'panic-high');
                panicElement.classList.add(isPanic ? 'panic-high' : 'panic-low');

                if (isPanic) {
                    alertMessage.textContent = "HMM ALERT: The market is statistically in the HIGH-VOLATILITY regime. Avoid selling options.";
                    alertMessage.style.color = '#d9534f';
                } else {
                    alertMessage.textContent = "HMM CHECK: The market is statistically in the LOW-VOLATILITY regime. Proceed with analysis.";
                    alertMessage.style.color = '#5cb85c';
                }
                
                // --- Draw Chart ---
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [
                            // 1. P_Panic Line
                            {
                                label: 'HMM Panic Probability',
                                data: data.p_panic,
                                borderColor: 'rgba(54, 162, 235, 1)', // Blue
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                yAxisID: 'y_prob',
                                fill: false,
                                tension: 0.1
                            },
                            // 2. VIX Line
                            {
                                label: 'VIX Close',
                                data: data.vix_close,
                                borderColor: 'rgba(255, 99, 132, 0.8)', // Red
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                yAxisID: 'y_vix',
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        title: {
                            display: true,
                            text: 'HMM Panic Probability vs. VIX Close'
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'month' },
                                title: { display: true, text: 'Date' }
                            },
                            y_prob: {
                                type: 'linear',
                                position: 'left',
                                title: { display: true, text: 'Panic Probability (0-1)' },
                                min: 0,
                                max: 1,
                                grid: { drawOnChartArea: true },
                                ticks: { stepSize: 0.1 }
                            },
                            y_vix: {
                                type: 'linear',
                                position: 'right',
                                title: { display: true, text: 'VIX Close' },
                                grid: { drawOnChartArea: false }
                            }
                        },
                        annotation: {
                            annotations: [{
                                type: 'line',
                                mode: 'horizontal',
                                scaleID: 'y_prob',
                                value: 0.5,
                                borderColor: 'rgba(128, 128, 128, 0.8)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                label: { enabled: true, content: 'Regime Switch Threshold (50%)', position: 'end' }
                            }]
                        }
                    }
                });
            } catch (error) {
                document.getElementById('loading').textContent = `Failed to load data: ${error}. Check console for details.`;
                console.error("Loading error:", error);
            }
        }
        
        loadChartData();
    </script>

</body>
</html>
